<div class="container-fluid mt-4">
    <h2 class="text-center mb-4">Gestión de Reservas</h2>
    
    <div class="row">
      <!-- Formulario de Reserva -->
      <div class="col-md-5">
        <div class="card">
          <div class="card-header bg-primary text-white">
            <h3 class="card-title mb-0">{{modoEdicion ? 'Editar' : 'Nueva'}} Reserva</h3>
          </div>
          <div class="card-body">
            <form (ngSubmit)="guardarReserva()" #reservaForm="ngForm">
              <div class="form-group">
                <label for="restaurante">Restaurante:</label>
                <select class="form-control" id="restaurante" [(ngModel)]="selectedRestauranteRuc" name="restaurante" (change)="onRestauranteChange()" required>
                  <option value="">Seleccione un restaurante</option>
                  <option *ngFor="let restaurante of restaurantes" [value]="restaurante.ruc">{{restaurante.nombre}}</option>
                </select>
              </div>
          
              <div class="form-group">
                <label for="email">Email:</label>
                <input type="email" class="form-control" id="email" [(ngModel)]="reserva.email" name="email" required>
              </div>
          
              <div class="form-group">
                <label for="fecha_destino">Fecha de Reserva:</label>
                <input type="datetime-local" class="form-control" id="fecha_destino" [(ngModel)]="reserva.fecha_destino" name="fecha_destino" required>
              </div>
          
              <div class="form-group">
                <label for="personas">Número de Personas:</label>
                <input type="number" class="form-control" id="personas" [(ngModel)]="reserva.personas" name="personas" required>
              </div>
          
              <div class="form-group">
                <label for="observacion">Observación:</label>
                <textarea class="form-control" id="observacion" [(ngModel)]="reserva.observacion" name="observacion"></textarea>
              </div>
          
              <div class="form-group">
                <label for="plato">Agregar Plato:</label>
                <div class="input-group">
                  <select class="form-control" id="plato" [(ngModel)]="selectedPlato" name="plato">
                    <option [ngValue]="null">Seleccione un plato</option>
                    <option *ngFor="let plato of platos" [ngValue]="plato">{{plato.nombre}}</option>
                  </select>
                  <input type="number" class="form-control" placeholder="Cantidad" [(ngModel)]="platosCantidad[selectedPlato?.id]" name="cantidad" min="1" *ngIf="selectedPlato">
                  <div class="input-group-append">
                    <button type="button" class="btn btn-secondary" (click)="agregarPlato()">Agregar</button>
                  </div>
                </div>
              </div>
          
              <table class="table table-sm mt-3" *ngIf="reserva.reserva_detalle.length > 0">
                <thead>
                  <tr>
                    <th>Plato</th>
                    <th>Cantidad</th>
                    <th>Subtotal</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let detalle of reserva.reserva_detalle; let i = index">
                    <td>{{getNombrePlato(detalle.id_carta)}}</td>
                    <td>{{detalle.cantidad}}</td>
                    <td>{{detalle.subtotal | currency}}</td>
                    <td>
                      <button type="button" class="btn btn-danger btn-sm" (click)="eliminarPlato(i)">
                        <i class="fas fa-trash"></i>
                      </button>
                    </td>
                  </tr>
                </tbody>
                <tfoot>
                  <tr>
                    <th colspan="2">Total:</th>
                    <th>{{reserva.monto | currency}}</th>
                    <th></th>
                  </tr>
                </tfoot>
              </table>
          
              <button type="submit" class="btn btn-primary btn-block" [disabled]="!reservaForm.form.valid">
                {{modoEdicion ? 'Actualizar' : 'Crear'}} Reserva
              </button>
            </form>
          </div>
        </div>
      </div>
  
      <!-- Lista de Reservas -->
      <div class="col-md-7">
        <div class="card">
          <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
            <h3 class="card-title mb-0">Listado de Reservas</h3>
            <div>
              <button class="btn btn-success mr-2" (click)="exportarAExcel()">Exportar a Excel</button>
              <button class="btn btn-danger" (click)="exportarAPDF()">Exportar a PDF</button>
            </div>
          </div>
          <div class="d-flex justify-content-end mb-2">
            <div class="form-group mb-0">
              <select class="form-control" id="filtroSituacion" [(ngModel)]="filtroSituacion" (change)="getReservas()">
                <option value="P">Pendientes</option>
                <option value="C">Confirmadas</option>
                <option value="A">Anuladas</option>
              </select>
            </div>
          </div>        
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>Restaurante</th>
                    <th>Personas</th>
                    <th>Monto</th>
                    <th>Situación</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let reserva of reservas">
                    <td>{{reserva.fecha_destino | date:'short'}}</td>
                    <td>{{reserva.ruc}}</td>
                    <td>{{reserva.personas}}</td>
                    <td>{{reserva.monto | currency}}</td>
                    <td>
                      <span class="badge" [ngClass]="{
                        'badge-warning': reserva.situacion === 'P',
                        'badge-success': reserva.situacion === 'C',
                        'badge-danger': reserva.situacion === 'A'
                      }">
                        {{reserva.situacion === 'P' ? 'Pendiente' : reserva.situacion === 'C' ? 'Confirmada' : 'Anulada'}}
                      </span>
                    </td>
                    <td>
                      <button class="btn btn-info btn-sm" (click)="verDetalles(reserva)" title="Ver Detalles">
                        <i class="fas fa-eye"></i>
                      </button>
                      <button *ngIf="reserva.situacion === 'P'" class="btn btn-success btn-sm ml-1" (click)="confirmarReserva(reserva.id)" title="Confirmar">
                        <i class="fas fa-check"></i>
                      </button>
                      <button *ngIf="reserva.situacion === 'C'" class="btn btn-warning btn-sm ml-1" (click)="anularReserva(reserva.id)" title="Anular">
                        <i class="fas fa-times"></i>
                      </button>
                      <button *ngIf="reserva.situacion === 'A'" class="btn btn-primary btn-sm ml-1" (click)="confirmarReserva(reserva.id)" title="Volver a Confirmar">
                        <i class="fas fa-redo"></i>
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>